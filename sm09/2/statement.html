<html><head><meta charset="utf-8"/></head>
<body>
<table border="1"><tr><td><b>Time limit:</b></td><td><tt>1 s</tt></td></tr>
<tr><td><b>Real time limit:</b></td><td><tt>5 s</tt></td></tr>
<tr><td><b>Memory limit:</b></td><td><tt>64M</tt></td></tr>
</table>
<h3>Problem sm09-2: unix/files/writechar-2</h3>
<p>Опишите структуру <tt>FileWriteState</tt> для хранения состояния буферизованного вывода в файл. Структура
может быть описана примерно так:</p>
<pre>struct FileWriteState
{
    int fd;              // "файловый дескриптор", для вывода на стандартный поток вывода - 1
    unsigned char *buf;  // указатель на буфер
    int bufsize;         // размер буфера
    // здесь потребуется добавить поля для реализации буферизованной записи
};</pre>
<p>Определите глобальную переменную:</p>
<pre>struct FileWriteState *stout;</pre>
<p>В вашей реализации переменная <tt>stout</tt> должна быть уже инициализирована корректным указателем
на корректную структуру состояния записи при запуске программы (то есть используйте инициализацию
глобальных переменных). Буфер должен быть выделен статически, его размер должен быть равен 4KiB.</p>
<p>Напишите подпрограммы <tt>writechar</tt> и <tt>flush</tt> для буферизированного посимвольного вывода.</p>
<pre>void writechar(int c, struct FileWriteState *out);
void flush(struct FileWriteState *out);</pre>
<p>Функция <tt>writechar</tt> принимает байт для вывода в параметре <code>c</code>,
    а в параметре <code>out</code> — указатель на структуру состояния вывода.
Этот байт не отправляется на поток вывода с помощью системного вызова write немедленно,
а накапливается в буфере вывода. Когда буфер вывода заполняется, вызывается подпрограмма <tt>flush</tt>
для записи содержимого буфера на устройство.</p>
<p>Функция <tt>flush</tt> принимает один парамер — указатель на структуру состояния вывода.
Функция использует системный вызов <tt>write</tt> для записи содержимого буфера
за один раз. Будем предполагать, что операция записи завершается успешно и полностью
записывает буфер. Размер буфера - 4KiB.</p>
<p>Решение будет компилироваться без стандартной библиотеки. Используйте ассемблерную вставку для совершения системного вызова write.</p>
<p>Подсказка для тестирования: программа, использующая <tt>writechar</tt>, должна не забыть вызвать <tt>flush</tt>
перед завершением, так как в противном случае будет потеряна часть данных, еще находящаяся в выходном буфере.</p>
<p> </p></body></html>